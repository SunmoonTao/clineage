import pytest

from tests.flat_dict import FlatDict


def test_flat_dict():
    fd = FlatDict({
        1: {
            2: {
                3: [
                    {'+':'a1','-':'a2'},
                    {'+':'b1'},
                    {'-':'c2'},
                ],
                4: {
                    9: [
                        {'-':'d2'},
                    ],
                },
            },
            5: [
                {'+':'e1','-':'e2'},
            ],
        },
        6: [
            {'+':'f1'},
        ],
        7: [
        ],
        8: {
        }
    })
    assert fd._d == {
        1: {'+': ['a1', 'b1', 'e1'], '-': ['a2', 'c2', 'd2', 'e2']},
        6: {'+': ['f1']},
        7: {},
        (1,): {'+': ['a1', 'b1', 'e1'], '-': ['a2', 'c2', 'd2', 'e2']},
        (1, 2): {'+': ['a1', 'b1'], '-': ['a2', 'c2', 'd2']},
        (1, 2, 3): {'+': ['a1', 'b1'], '-': ['a2', 'c2']},
        (1, 2, 4): {'-': ['d2']},
        (1, 2, 4, 9): {'-': ['d2']},
        (1, 5): {'+': ['e1'], '-': ['e2']},
        (6,): {'+': ['f1']},
        (7,): {},
    }  # FIXME
    assert fd._keys_tree == {
        1: {2, 5},
        (1,): {2, 5},
        (1, 2): {3, 4},
        (1, 2, 4): {9},
        (): {1, 6, 7}
    }  # FIXME
    assert fd[1,2,3] == {'+': ['a1', 'b1'], '-': ['a2', 'c2']}
    assert set(fd.keys((1, 2))) == {3, 4}
    assert set(fd.keys()) == {1, 6, 7}
    assert dict(fd.items((1, 2))) == {
        3: {'+': ['a1', 'b1'], '-': ['a2', 'c2']},
        4: {'-': ['d2']},
    }
    assert dict(fd.items()) == {
        1: {'+': ['a1', 'b1', 'e1'], '-': ['a2', 'c2', 'd2', 'e2']},
        6: {'+': ['f1']},
        7: {},
    }
    with pytest.raises(KeyError):
        fd[1,2,5]


def test_flat_dict2():
    fd = FlatDict({
        1: {
            2: {
                3: [
                    {'+':'a1','-':'a2'},
                    {'+':'b1'},
                    {'-':'c2'},
                ],
                4: {
                    9: [
                        {'-':'d2'},
                    ],
                },
            },
            5: [
                {'+':'e1','-':'e2'},
            ],
        },
        6: [
            {'+':'f1'},
        ],
        7: [
        ],
        8: {
        }
    }, deinterlaced_keys=['+','-'])
    assert fd._d == {
        1: {'+': ['a1', 'b1', 'e1'], '-': ['a2', 'c2', 'd2', 'e2']},
        6: {'+': ['f1'], '-': []},
        7: {'+': [], '-': []},
        (1,): {'+': ['a1', 'b1', 'e1'], '-': ['a2', 'c2', 'd2', 'e2']},
        (1, 2): {'+': ['a1', 'b1'], '-': ['a2', 'c2', 'd2']},
        (1, 2, 3): {'+': ['a1', 'b1'], '-': ['a2', 'c2']},
        (1, 2, 4): {'+': [], '-': ['d2']},
        (1, 2, 4, 9): {'+': [], '-': ['d2']},
        (1, 5): {'+': ['e1'], '-': ['e2']},
        (6,): {'+': ['f1'], '-': []},
        (7,): {'+': [], '-': []},
    }  # FIXME
    assert fd._keys_tree == {
        1: {2, 5},
        (1,): {2, 5},
        (1, 2): {3, 4},
        (1, 2, 4): {9},
        (): {1, 6, 7}
    }  # FIXME
    assert fd[1,2,3] == {'+': ['a1', 'b1'], '-': ['a2', 'c2']}
    assert set(fd.keys((1, 2))) == {3, 4}
    assert set(fd.keys()) == {1, 6, 7}
    assert dict(fd.items((1, 2))) == {
        3: {'+': ['a1', 'b1'], '-': ['a2', 'c2']},
        4: {'+': [], '-': ['d2']},
    }
    assert dict(fd.items()) == {
        1: {'+': ['a1', 'b1', 'e1'], '-': ['a2', 'c2', 'd2', 'e2']},
        6: {'+': ['f1'], '-': []},
        7: {'+': [], '-': []},
    }
    assert fd[1,2,5] == {'+': [], '-': []}
